@* Views/Reports/CashStatement.cshtml - Cash Tracking from Vouchers *@
@{
    ViewData["Title"] = "Cash Statement";
    var vouchers = ViewBag.Vouchers as IEnumerable<VoucherManagementSystem.Models.Voucher>;
    var cashAdjustments = ViewBag.CashAdjustments as IEnumerable<VoucherManagementSystem.Models.CashAdjustment>;
    var fromDate = ViewBag.FromDate != null ? (DateTime)ViewBag.FromDate : DateTime.Today.AddMonths(-1);
    var toDate = ViewBag.ToDate != null ? (DateTime)ViewBag.ToDate : DateTime.Today;
    var selectedCustomerId = ViewBag.SelectedCustomerId as int?;
    var selectedVoucherType = ViewBag.SelectedVoucherType as string;
    var openingBalance = ViewBag.OpeningBalance != null ? (decimal)ViewBag.OpeningBalance : 0;
}

<div class="d-print-none">
    <h2><i class="bi bi-cash-stack"></i> Cash Statement Report</h2>
</div>

<!-- Filter Form -->
<div class="card mb-3 d-print-none">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-filter"></i> Filter Options</h5>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label class="form-label">From Date <span class="text-danger">*</span></label>
                <input type="date" name="fromDate" value="@fromDate.ToString("yyyy-MM-dd")" class="form-control" required />
            </div>
            <div class="col-md-2">
                <label class="form-label">To Date <span class="text-danger">*</span></label>
                <input type="date" name="toDate" value="@toDate.ToString("yyyy-MM-dd")" class="form-control" required />
            </div>
            <div class="col-md-3">
                <label class="form-label">Filter by Customer</label>
                @if (ViewBag.Customers != null)
                {
                    @Html.DropDownList("customerId", ViewBag.Customers as SelectList, "-- All Customers --", new { @class = "form-select" })
                }
            </div>
            <div class="col-md-3">
                <label class="form-label">Filter by Voucher Type</label>
                @if (ViewBag.VoucherTypes != null)
                {
                    @Html.DropDownList("voucherType", ViewBag.VoucherTypes as SelectList, new { @class = "form-select" })
                }
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <button type="submit" class="btn btn-success w-100">
                    <i class="bi bi-search"></i> Generate
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Admin Cash Adjustment Buttons -->
<div class="mb-3 d-print-none">
    <a asp-action="AddCashAdjustment" asp-route-type="CashIn" class="btn btn-success">
        <i class="bi bi-plus-circle"></i> Add Cash (Cash In)
    </a>
    <a asp-action="AddCashAdjustment" asp-route-type="CashOut" class="btn btn-danger">
        <i class="bi bi-dash-circle"></i> Remove Cash (Cash Out)
    </a>
</div>

<!-- Report Header -->
<div class="card mb-3">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">
            <i class="bi bi-cash-stack"></i> Cash In Hand - Statement
        </h5>
        <small>Period: @fromDate.ToString("dd-MMM-yyyy") to @toDate.ToString("dd-MMM-yyyy")</small>
        @if (selectedCustomerId.HasValue && ViewBag.SelectedCustomer != null)
        {
            var customer = ViewBag.SelectedCustomer as VoucherManagementSystem.Models.Customer;
            <text> | Customer: @customer?.Name</text>
        }
        @if (!string.IsNullOrEmpty(selectedVoucherType))
        {
            <text> | Type: @selectedVoucherType</text>
        }
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3">
                <div class="card bg-secondary text-white">
                    <div class="card-body text-center">
                        <h6>Opening Balance</h6>
                        <h4 class="mb-0">Rs. @string.Format("{0:N0}", openingBalance)</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h6>Total Receipts</h6>
                        <h4 class="mb-0">Rs. @string.Format("{0:N0}", ViewBag.TotalReceipts ?? 0)</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <h6>Total Payments</h6>
                        <h4 class="mb-0">Rs. @string.Format("{0:N0}", ViewBag.TotalPayments ?? 0)</h4>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h6>Closing Balance</h6>
                        <h4 class="mb-0">Rs. @string.Format("{0:N0}", ViewBag.ClosingBalance ?? 0)</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Cash Transactions</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-sm" id="cashStatementTable">
                <thead class="table-dark">
                    <tr>
                        <th>Date</th>
                        <th>Transaction No</th>
                        <th>Type</th>
                        <th>Customer/Party</th>
                        <th>Description</th>
                        <th class="text-end">Receipt (In)</th>
                        <th class="text-end">Payment (Out)</th>
                        <th class="text-end">Balance</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal runningBalance = openingBalance;
                        decimal totalReceipts = 0;
                        decimal totalPayments = 0;

                        // Combine vouchers and adjustments into one list for proper sorting
                        var allTransactions = new List<(DateTime Date, int Id, string TransNo, string Type, string Customer, string Desc, decimal Receipt, decimal Payment, bool IsVoucher)>();

                        // Add vouchers
                        if (vouchers != null)
                        {
                            foreach (var v in vouchers)
                            {
                                decimal receipt = 0;
                                decimal payment = 0;
                                string customerName = "";
                                string description = "";

                                switch (v.VoucherType)
                                {
                                    case VoucherManagementSystem.Models.VoucherType.Sale:
                                        receipt = v.Amount;
                                        customerName = v.ReceivingCustomer?.Name ?? v.ReceivingCustomerDetails ?? "N/A";
                                        description = $"Sale - {v.Item?.Name ?? "N/A"}";
                                        break;
                                    case VoucherManagementSystem.Models.VoucherType.CashReceived:
                                        receipt = v.Amount;
                                        customerName = v.ReceivingCustomer?.Name ?? v.ReceivingCustomerDetails ?? "N/A";
                                        description = "Cash Received";
                                        break;
                                    case VoucherManagementSystem.Models.VoucherType.Purchase:
                                        payment = v.Amount;
                                        customerName = v.PurchasingCustomer?.Name ?? v.PurchasingCustomerDetails ?? "N/A";
                                        description = $"Purchase - {v.Item?.Name ?? "N/A"}";
                                        break;
                                    case VoucherManagementSystem.Models.VoucherType.Expense:
                                        payment = v.Amount;
                                        customerName = v.ExpenseHead?.Name ?? "Expense";
                                        description = v.ExpenseHeadDetails ?? "Expense";
                                        break;
                                    case VoucherManagementSystem.Models.VoucherType.CashPaid:
                                        payment = v.Amount;
                                        customerName = v.PurchasingCustomer?.Name ?? v.PurchasingCustomerDetails ?? "N/A";
                                        description = "Cash Paid";
                                        break;
                                    case VoucherManagementSystem.Models.VoucherType.Hazri:
                                        payment = v.Amount;
                                        customerName = "Labor";
                                        description = $"Hazri - {v.ExpenseHead?.Name ?? v.Item?.Name ?? "Labor"}";
                                        break;
                                }

                                allTransactions.Add((v.VoucherDate, v.Id, v.TransactionNumber, v.VoucherType.ToString(), customerName, description, receipt, payment, true));
                            }
                        }

                        // Add cash adjustments
                        if (cashAdjustments != null)
                        {
                            foreach (var adj in cashAdjustments)
                            {
                                bool isCashIn = adj.AdjustmentType == VoucherManagementSystem.Models.CashAdjustmentType.CashIn;
                                allTransactions.Add((
                                    adj.AdjustmentDate,
                                    adj.Id,
                                    adj.ReferenceNumber ?? "ADJ",
                                    isCashIn ? "Cash In" : "Cash Out",
                                    "Admin",
                                    adj.Description ?? (isCashIn ? "Cash Added by Admin" : "Cash Removed by Admin"),
                                    isCashIn ? adj.Amount : 0,
                                    isCashIn ? 0 : adj.Amount,
                                    false
                                ));
                            }
                        }

                        // Sort by date and ID
                        allTransactions = allTransactions.OrderBy(t => t.Date).ThenBy(t => t.Id).ToList();
                    }

                    <!-- Opening Balance Row -->
                    <tr class="table-secondary">
                        <td>@fromDate.ToString("dd-MMM-yy")</td>
                        <td>-</td>
                        <td><span class="badge bg-secondary">Opening</span></td>
                        <td>-</td>
                        <td><strong>Opening Balance</strong></td>
                        <td class="text-end">-</td>
                        <td class="text-end">-</td>
                        <td class="text-end fw-bold text-primary">@string.Format("{0:N0}", openingBalance)</td>
                    </tr>

                    @foreach (var trans in allTransactions)
                    {
                        runningBalance += trans.Receipt - trans.Payment;
                        totalReceipts += trans.Receipt;
                        totalPayments += trans.Payment;

                        <tr>
                            <td>@trans.Date.ToString("dd-MMM-yy")</td>
                            <td>
                                @if (trans.IsVoucher)
                                {
                                    <a asp-controller="Vouchers" asp-action="Details" asp-route-id="@trans.Id">@trans.TransNo</a>
                                }
                                else
                                {
                                    @trans.TransNo
                                }
                            </td>
                            <td><span class="badge bg-@(trans.Receipt > 0 ? "success" : "danger")">@trans.Type</span></td>
                            <td>@trans.Customer</td>
                            <td>@trans.Desc</td>
                            <td class="text-end">
                                @if (trans.Receipt > 0)
                                {
                                    <span class="text-success">@string.Format("{0:N0}", trans.Receipt)</span>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                            <td class="text-end">
                                @if (trans.Payment > 0)
                                {
                                    <span class="text-danger">@string.Format("{0:N0}", trans.Payment)</span>
                                }
                                else
                                {
                                    <text>-</text>
                                }
                            </td>
                            <td class="text-end fw-bold @(runningBalance >= 0 ? "text-primary" : "text-danger")">@string.Format("{0:N0}", runningBalance)</td>
                        </tr>
                    }

                    @if (!allTransactions.Any())
                    {
                        <tr>
                            <td colspan="8" class="text-center">No cash transactions found for the selected period.</td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="5" class="text-end">Period Total:</th>
                        <th class="text-end">Rs. @string.Format("{0:N0}", totalReceipts)</th>
                        <th class="text-end">Rs. @string.Format("{0:N0}", totalPayments)</th>
                        <th class="text-end"></th>
                    </tr>
                    <tr>
                        <th colspan="5" class="text-end">Closing Balance (as of @toDate.ToString("dd-MMM-yyyy")):</th>
                        <th colspan="2" class="text-end"></th>
                        <th class="text-end">Rs. @string.Format("{0:N0}", openingBalance + totalReceipts - totalPayments)</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="mt-3 d-print-none">
    <button onclick="window.print()" class="btn btn-primary">
        <i class="bi bi-printer"></i> Print Statement
    </button>
    <button onclick="exportTableToExcel('cashStatementTable', 'CashStatement_@fromDate.ToString("yyyyMMdd")_@toDate.ToString("yyyyMMdd")')" class="btn btn-success">
        <i class="bi bi-file-earmark-excel"></i> Export to Excel
    </button>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Reports
    </a>
</div>

@section Scripts {
    <script>
        function exportTableToExcel(tableID, filename = ''){
            var downloadLink;
            var dataType = 'application/vnd.ms-excel';
            var tableSelect = document.getElementById(tableID);
            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

            filename = filename?filename+'.xls':'excel_data.xls';
            downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);

            if(navigator.msSaveOrOpenBlob){
                var blob = new Blob(['\ufeff', tableHTML], {
                    type: dataType
                });
                navigator.msSaveOrOpenBlob( blob, filename);
            }else{
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
                downloadLink.download = filename;
                downloadLink.click();
            }
        }
    </script>

    <style>
        @@media print {
            .card { page-break-inside: avoid; }
            .table { font-size: 9pt; }
        }
    </style>
}
