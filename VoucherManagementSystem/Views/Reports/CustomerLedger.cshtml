@* Views/Reports/CustomerLedger.cshtml *@
@{
    ViewData["Title"] = "Customer Ledger";
}

<div class="d-print-none">
    <h2><i class="bi bi-person-lines-fill"></i> Customer Ledger Report</h2>
</div>

@if (ViewBag.Customer == null)
{
    <!-- Selection Form -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-filter"></i> Select Customer</h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Customer <span class="text-danger">*</span></label>
                    @Html.DropDownList("customerId", ViewBag.Customers as SelectList, "Select Customer", new { @class = "form-select", required = "required" })
                </div>
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" name="fromDate" class="form-control" value="@DateTime.Today.AddDays(-90).ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" name="toDate" class="form-control" value="@DateTime.Today.ToString("yyyy-MM-dd")" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
}
else
{
    var customer = ViewBag.Customer as VoucherManagementSystem.Models.Customer;
    var openingBalance = (decimal)ViewBag.OpeningBalance;
    var totalDebit = (decimal)ViewBag.TotalDebit;
    var totalCredit = (decimal)ViewBag.TotalCredit;
    var closingBalance = (decimal)ViewBag.ClosingBalance;
    var vouchers = ViewBag.Vouchers as List<VoucherManagementSystem.Models.Voucher>;
    var fromDate = (DateTime)ViewBag.FromDate;
    var toDate = (DateTime)ViewBag.ToDate;

    <!-- Filter Form -->
    <div class="card mb-3 d-print-none">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Customer</label>
                    @Html.DropDownList("customerId", ViewBag.Customers as SelectList, "Select Customer", new { @class = "form-select" })
                </div>
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" name="fromDate" value="@fromDate.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" name="toDate" value="@toDate.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Update
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Report Header -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-person-badge"></i> @customer.Name - Ledger Account</h5>
            <small>Period: @fromDate.ToString("dd-MMM-yyyy") to @toDate.ToString("dd-MMM-yyyy")</small>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Customer Name:</strong> @customer.Name</p>
                    <p><strong>Phone:</strong> @customer.Phone</p>
                    <p><strong>Address:</strong> @customer.Address</p>
                </div>
                <div class="col-md-6">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="text-muted">Opening Balance</h6>
                                    <h4 class="@(openingBalance >= 0 ? "text-success" : "text-danger")">
                                        Rs. @string.Format("{0:N0}", Math.Abs(openingBalance))
                                        <small>@(openingBalance >= 0 ? "Dr" : "Cr")</small>
                                    </h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="text-muted">Closing Balance</h6>
                                    <h4 class="@(closingBalance >= 0 ? "text-success" : "text-danger")">
                                        Rs. @string.Format("{0:N0}", Math.Abs(closingBalance))
                                        <small>@(closingBalance >= 0 ? "Dr" : "Cr")</small>
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ledger Transactions -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-list-ul"></i> Transaction Details</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-bordered" id="ledgerTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Date</th>
                            <th>Transaction No.</th>
                            <th>Type</th>
                            <th>Particulars</th>
                            <th class="text-end">Debit (Dr)</th>
                            <th class="text-end">Credit (Cr)</th>
                            <th class="text-end">Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Opening Balance Row -->
                        <tr class="table-secondary">
                            <td>@fromDate.ToString("dd-MMM-yyyy")</td>
                            <td colspan="3"><strong>Opening Balance</strong></td>
                            <td class="text-end">@(openingBalance > 0 ? string.Format("{0:N0}", openingBalance) : "-")</td>
                            <td class="text-end">@(openingBalance < 0 ? string.Format("{0:N0}", Math.Abs(openingBalance)) : "-")</td>
                            <td class="text-end">
                                <strong>@string.Format("{0:N0}", Math.Abs(openingBalance)) @(openingBalance >= 0 ? "Dr" : "Cr")</strong>
                            </td>
                        </tr>

                        @if (vouchers != null && vouchers.Any())
                        {
                            decimal runningBalance = openingBalance;
                            foreach (var voucher in vouchers)
                            {
                                decimal debit = 0;
                                decimal credit = 0;
                                string particulars = "";

                                // Determine debit/credit based on voucher type and customer role
                                if (voucher.PurchasingCustomerId == customer.Id)
                                {
                                    switch (voucher.VoucherType)
                                    {
                                        case VoucherManagementSystem.Models.VoucherType.Purchase:
                                            debit = voucher.Amount;
                                            particulars = $"Purchase - {voucher.Item?.Name ?? "N/A"} ({voucher.PurchasingCustomerDetails})";
                                            break;
                                        case VoucherManagementSystem.Models.VoucherType.CashPaid:
                                            debit = voucher.Amount;
                                            particulars = $"Cash Paid ({voucher.PurchasingCustomerDetails})";
                                            break;
                                        case VoucherManagementSystem.Models.VoucherType.CCR:
                                            debit = voucher.Amount;
                                            particulars = $"CCR - From {voucher.ReceivingCustomer?.Name ?? "N/A"}";
                                            break;
                                    }
                                }

                                if (voucher.ReceivingCustomerId == customer.Id)
                                {
                                    switch (voucher.VoucherType)
                                    {
                                        case VoucherManagementSystem.Models.VoucherType.Sale:
                                            credit = voucher.Amount;
                                            particulars = $"Sale - {voucher.Item?.Name ?? "N/A"} ({voucher.ReceivingCustomerDetails})";
                                            break;
                                        case VoucherManagementSystem.Models.VoucherType.CashReceived:
                                            credit = voucher.Amount;
                                            particulars = $"Cash Received ({voucher.ReceivingCustomerDetails})";
                                            break;
                                        case VoucherManagementSystem.Models.VoucherType.CCR:
                                            credit = voucher.Amount;
                                            particulars = $"CCR - To {voucher.PurchasingCustomer?.Name ?? "N/A"}";
                                            break;
                                    }
                                }

                                runningBalance += debit - credit;

                                <tr>
                                    <td>@voucher.VoucherDate.ToString("dd-MMM-yyyy")</td>
                                    <td>@voucher.TransactionNumber</td>
                                    <td>
                                        <span class="badge bg-@(voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Purchase ? "primary" :
                                                              voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Sale ? "success" :
                                                              voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.CashPaid ? "warning" :
                                                              voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.CashReceived ? "info" : "secondary")">
                                            @voucher.VoucherType
                                        </span>
                                    </td>
                                    <td>@particulars</td>
                                    <td class="text-end">@(debit > 0 ? string.Format("{0:N0}", debit) : "-")</td>
                                    <td class="text-end">@(credit > 0 ? string.Format("{0:N0}", credit) : "-")</td>
                                    <td class="text-end">
                                        <strong>@string.Format("{0:N0}", Math.Abs(runningBalance)) @(runningBalance >= 0 ? "Dr" : "Cr")</strong>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center">No transactions found for the selected period.</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-dark">
                        <tr>
                            <th colspan="4" class="text-end">Total:</th>
                            <th class="text-end">Rs. @string.Format("{0:N0}", totalDebit)</th>
                            <th class="text-end">Rs. @string.Format("{0:N0}", totalCredit)</th>
                            <th class="text-end">
                                Rs. @string.Format("{0:N0}", Math.Abs(closingBalance)) @(closingBalance >= 0 ? "Dr" : "Cr")
                            </th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-3 d-print-none">
        <button onclick="window.print()" class="btn btn-primary">
            <i class="bi bi-printer"></i> Print Ledger
        </button>
        <button onclick="exportTableToExcel('ledgerTable', 'CustomerLedger_@customer.Name.Replace(" ", "_")_@DateTime.Now.ToString("yyyyMMdd")')" class="btn btn-success">
            <i class="bi bi-file-earmark-excel"></i> Export to Excel
        </button>
        <a asp-controller="Reports" asp-action="ExportToExcel" asp-route-reportType="customerLedger"
           asp-route-id="@customer.Id" asp-route-fromDate="@fromDate" asp-route-toDate="@toDate" class="btn btn-warning">
            <i class="bi bi-download"></i> Download Full Report
        </a>
        <a asp-action="CustomerLedger" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> New Customer
        </a>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="bi bi-house"></i> Back to Reports
        </a>
    </div>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#ledgerTable').DataTable({
                "paging": false,
                "searching": false,
                "info": false,
                "ordering": false
            });
        });

        function exportTableToExcel(tableID, filename = ''){
            var downloadLink;
            var dataType = 'application/vnd.ms-excel';
            var tableSelect = document.getElementById(tableID);
            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

            filename = filename?filename+'.xls':'excel_data.xls';
            downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);

            if(navigator.msSaveOrOpenBlob){
                var blob = new Blob(['\ufeff', tableHTML], {
                    type: dataType
                });
                navigator.msSaveOrOpenBlob( blob, filename);
            }else{
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
                downloadLink.download = filename;
                downloadLink.click();
            }
        }
    </script>

    <style>
        @@media print {
            .card {
                page-break-inside: avoid;
            }

            .table {
                font-size: 9pt;
            }

            .badge {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
}
