@* Views/Reports/CashFlow.cshtml *@
@{
    ViewData["Title"] = "Cash Flow Report";
    var cashIn = ViewBag.CashIn != null ? (decimal)ViewBag.CashIn : 0;
    var cashOut = ViewBag.CashOut != null ? (decimal)ViewBag.CashOut : 0;
    var openingBalance = ViewBag.OpeningBalance != null ? (decimal)ViewBag.OpeningBalance : 0;
    var closingBalance = ViewBag.ClosingBalance != null ? (decimal)ViewBag.ClosingBalance : 0;
    var fromDate = ViewBag.FromDate != null ? (DateTime)ViewBag.FromDate : DateTime.Today.AddDays(-30);
    var toDate = ViewBag.ToDate != null ? (DateTime)ViewBag.ToDate : DateTime.Today;
    var vouchers = ViewBag.CashVouchers as IEnumerable<VoucherManagementSystem.Models.Voucher>;
}

<div class="d-print-none">
    <h2><i class="bi bi-cash-stack"></i> Cash Flow Report</h2>

    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">From Date</label>
                    <input type="date" name="fromDate" value="@fromDate.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">To Date</label>
                    <input type="date" name="toDate" value="@toDate.ToString("yyyy-MM-dd")" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-cash"></i> Cash Flow Summary
        </h5>
        <small>Period: @fromDate.ToString("dd-MMM-yyyy") to @toDate.ToString("dd-MMM-yyyy")</small>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h6 class="card-title">Opening Balance</h6>
                        <h3 class="mb-0">Rs. @string.Format("{0:N0}", openingBalance)</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title">Cash In</h6>
                        <h3 class="mb-0">Rs. @string.Format("{0:N0}", cashIn)</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h6 class="card-title">Cash Out</h6>
                        <h3 class="mb-0">Rs. @string.Format("{0:N0}", cashOut)</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-@(closingBalance >= 0 ? "primary" : "warning") text-white">
                    <div class="card-body">
                        <h6 class="card-title">Closing Balance</h6>
                        <h3 class="mb-0">Rs. @string.Format("{0:N0}", closingBalance)</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <canvas id="cashFlowChart" width="400" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Cash Transactions</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-sm" id="cashFlowTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Transaction No</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Customer/Party</th>
                        <th class="text-end">Cash In</th>
                        <th class="text-end">Cash Out</th>
                        <th class="text-end">Balance</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal runningBalance = openingBalance;
                        if (vouchers != null)
                        {
                            foreach (var voucher in vouchers)
                            {
                                bool isCashIn = (voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Sale ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.CashReceived) &&
                                voucher.CashType == VoucherManagementSystem.Models.CashType.Cash;
                                bool isCashOut = (voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Purchase ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Expense ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.CashPaid ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Hazri) &&
                                voucher.CashType == VoucherManagementSystem.Models.CashType.Cash;

                                if (isCashIn)
                                    runningBalance += voucher.Amount;
                                else if (isCashOut)
                                    runningBalance -= voucher.Amount;

                                <tr>
                                    <td>@voucher.VoucherDate.ToString("dd-MMM-yy")</td>
                                    <td>
                                        <a asp-controller="Vouchers" asp-action="Details" asp-route-id="@voucher.Id">
                                            @voucher.TransactionNumber
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@voucher.VoucherType</span>
                                    </td>
                                    <td>
                                        @(voucher.Item?.Name ?? voucher.ExpenseHead?.Name ??
                                        voucher.PurchasingCustomerDetails ?? voucher.ReceivingCustomerDetails ??
                                        "Cash Transaction")
                                    </td>
                                    <td>
                                        @(voucher.PurchasingCustomer?.Name ?? voucher.ReceivingCustomer?.Name ?? "-")
                                    </td>
                                    <td class="text-end">
                                        @if (isCashIn)
                                        {
                                            <span class="text-success">@string.Format("{0:N0}", voucher.Amount)</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (isCashOut)
                                        {
                                            <span class="text-danger">@string.Format("{0:N0}", voucher.Amount)</span>
                                        }
                                    </td>
                                    <td class="text-end fw-bold @(runningBalance >= 0 ? "text-primary" : "text-danger")">
                                        @string.Format("{0:N0}", runningBalance)
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <th colspan="5">Total</th>
                        <th class="text-end">@string.Format("{0:N0}", cashIn)</th>
                        <th class="text-end">@string.Format("{0:N0}", cashOut)</th>
                        <th class="text-end">@string.Format("{0:N0}", closingBalance)</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="mt-3 d-print-none">
    <button onclick="window.print()" class="btn btn-primary">
        <i class="bi bi-printer"></i> Print Report
    </button>
    <a asp-action="DailyCashBook" class="btn btn-info">
        <i class="bi bi-journal-text"></i> Daily Cash Book
    </a>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Reports
    </a>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        $(document).ready(function() {
            $('#cashFlowTable').DataTable({
                "order": [[0, "asc"]],
                "pageLength": 50
            });

            // Create cash flow chart
            var ctx = document.getElementById('cashFlowChart').getContext('2d');
            var myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Opening Balance', 'Cash In', 'Cash Out', 'Closing Balance'],
                    datasets: [{
                        label: 'Amount (Rs.)',
                        data: [@openingBalance, @cashIn, @cashOut, @closingBalance],
                        backgroundColor: [
                            'rgba(23, 162, 184, 0.5)',
                            'rgba(40, 167, 69, 0.5)',
                            'rgba(220, 53, 69, 0.5)',
                            'rgba(13, 110, 253, 0.5)'
                        ],
                        borderColor: [
                            'rgba(23, 162, 184, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)',
                            'rgba(13, 110, 253, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
    </script>
}