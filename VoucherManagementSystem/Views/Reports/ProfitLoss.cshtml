@* Views/Reports/ProfitLoss.cshtml *@
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    ViewData["Title"] = "Profit & Loss Report";
    var project = ViewBag.Project as VoucherManagementSystem.Models.Project;
    var vouchers = ViewBag.Vouchers as IEnumerable<VoucherManagementSystem.Models.Voucher>;
    var revenue = ViewBag.Revenue != null ? (decimal)ViewBag.Revenue : 0;
    var expenses = ViewBag.Expenses != null ? (decimal)ViewBag.Expenses : 0;
    var profitLoss = ViewBag.ProfitLoss != null ? (decimal)ViewBag.ProfitLoss : 0;
    var fromDate = ViewBag.FromDate != null ? (DateTime)ViewBag.FromDate : DateTime.Today.AddMonths(-1);
    var toDate = ViewBag.ToDate != null ? (DateTime)ViewBag.ToDate : DateTime.Today;
    var selectedVoucherType = ViewBag.SelectedVoucherType as string;
    var selectedItemId = ViewBag.SelectedItemId as int?;
    var selectedCustomerId = ViewBag.SelectedCustomerId as int?;
    var items = ViewBag.Items as SelectList;
    var customers = ViewBag.Customers as SelectList;
}

<div class="d-print-none">
    <h2><i class="bi bi-bar-chart"></i> Profit & Loss Report</h2>

    <!-- Filter Section -->
    <div class="card mb-3">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-funnel"></i> Filter Options</h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="ProjectReport" class="row g-3">
                <input type="hidden" name="projectId" value="@(project?.Id)" />

                <div class="col-md-2">
                    <label class="form-label"><i class="bi bi-calendar"></i> From Date</label>
                    <input type="date" name="fromDate" class="form-control" value="@fromDate.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-2">
                    <label class="form-label"><i class="bi bi-calendar"></i> To Date</label>
                    <input type="date" name="toDate" class="form-control" value="@toDate.ToString("yyyy-MM-dd")" />
                </div>

                <div class="col-md-3">
                    <label class="form-label"><i class="bi bi-tag"></i> Voucher Type</label>
                    <select name="voucherType" class="form-select">
                        <option value="">-- All Types --</option>
                        @if (selectedVoucherType == "Purchase")
                        {
                            <option value="Purchase" selected>Purchase</option>
                        }
                        else
                        {
                            <option value="Purchase">Purchase</option>
                        }
                        @if (selectedVoucherType == "Sale")
                        {
                            <option value="Sale" selected>Sale</option>
                        }
                        else
                        {
                            <option value="Sale">Sale</option>
                        }
                        @if (selectedVoucherType == "Expense")
                        {
                            <option value="Expense" selected>Expense</option>
                        }
                        else
                        {
                            <option value="Expense">Expense</option>
                        }
                        @if (selectedVoucherType == "Hazri")
                        {
                            <option value="Hazri" selected>Hazri</option>
                        }
                        else
                        {
                            <option value="Hazri">Hazri</option>
                        }
                        @if (selectedVoucherType == "CashReceived")
                        {
                            <option value="CashReceived" selected>Cash Received</option>
                        }
                        else
                        {
                            <option value="CashReceived">Cash Received</option>
                        }
                        @if (selectedVoucherType == "CashPaid")
                        {
                            <option value="CashPaid" selected>Cash Paid</option>
                        }
                        else
                        {
                            <option value="CashPaid">Cash Paid</option>
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label"><i class="bi bi-box-seam"></i> Item</label>
                    <select name="itemId" class="form-select">
                        <option value="">-- All Items --</option>
                        @if (items != null)
                        {
                            @foreach (var item in items)
                            {
                                @if (selectedItemId?.ToString() == item.Value)
                                {
                                    <option value="@item.Value" selected>@item.Text</option>
                                }
                                else
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            }
                        }
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label"><i class="bi bi-person"></i> Customer</label>
                    <select name="customerId" class="form-select">
                        <option value="">-- All Customers --</option>
                        @if (customers != null)
                        {
                            @foreach (var customer in customers)
                            {
                                @if (selectedCustomerId?.ToString() == customer.Value)
                                {
                                    <option value="@customer.Value" selected>@customer.Text</option>
                                }
                                else
                                {
                                    <option value="@customer.Value">@customer.Text</option>
                                }
                            }
                        }
                    </select>
                </div>

                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search"></i> Filter
                    </button>
                </div>
            </form>

            @if (!string.IsNullOrEmpty(selectedVoucherType) || selectedItemId.HasValue || selectedCustomerId.HasValue)
            {
                <div class="mt-2 text-end">
                    <a asp-action="ProjectReport"
                       asp-route-projectId="@(project?.Id)"
                       asp-route-fromDate="@fromDate.ToString("yyyy-MM-dd")"
                       asp-route-toDate="@toDate.ToString("yyyy-MM-dd")"
                       class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-x-circle"></i> Clear Filters
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(selectedVoucherType) || selectedItemId.HasValue || selectedCustomerId.HasValue)
{
    <div class="alert alert-info d-print-none">
        <strong><i class="bi bi-funnel"></i> Active Filters:</strong>
        @if (!string.IsNullOrEmpty(selectedVoucherType))
        {
            <span class="badge bg-primary ms-2">Type: @selectedVoucherType</span>
        }
        @if (selectedItemId.HasValue && items != null)
        {
            var itemName = items.FirstOrDefault(i => i.Value == selectedItemId.ToString())?.Text ?? "Unknown";
            <span class="badge bg-success ms-2">Item: @itemName</span>
        }
        @if (selectedCustomerId.HasValue && customers != null)
        {
            var customerName = customers.FirstOrDefault(c => c.Value == selectedCustomerId.ToString())?.Text ?? "Unknown";
            <span class="badge bg-warning text-dark ms-2">Customer: @customerName</span>
        }
    </div>
}

<div class="card mb-3">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-briefcase"></i> @(project?.Name ?? "Project") - P&L Statement
        </h5>
        <small>Period: @fromDate.ToString("dd-MMM-yyyy") to @toDate.ToString("dd-MMM-yyyy")</small>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-md-4">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-arrow-up-circle"></i> Total Revenue
                        </h6>
                        <h3 class="mb-0">Rs. @string.Format("{0:N0}", revenue)</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-arrow-down-circle"></i> Total Expenses
                        </h6>
                        <h3 class="mb-0">Rs. @string.Format("{0:N0}", expenses)</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-@(profitLoss >= 0 ? "info" : "warning") text-white">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="bi bi-@(profitLoss >= 0 ? "graph-up" : "graph-down")"></i>
                            Net @(profitLoss >= 0 ? "Profit" : "Loss")
                        </h6>
                        <h3 class="mb-0">Rs. @string.Format("{0:N0}", Math.Abs(profitLoss))</h3>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-12">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <tbody>
                            <tr>
                                <th width="50%">Revenue Percentage:</th>
                                <td>@(revenue + expenses > 0 ? ((revenue / (revenue + expenses)) * 100).ToString("N2") : "0.00")%</td>
                            </tr>
                            <tr>
                                <th>Expense Percentage:</th>
                                <td>@(revenue + expenses > 0 ? ((expenses / (revenue + expenses)) * 100).ToString("N2") : "0.00")%</td>
                            </tr>
                            <tr>
                                <th>Profit Margin:</th>
                                <td class="@(profitLoss >= 0 ? "text-success" : "text-danger") fw-bold">
                                    @(revenue > 0 ? ((profitLoss / revenue) * 100).ToString("N2") : "0.00")%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        @{
            var itemSummary = ViewBag.ItemSummary as List<VoucherManagementSystem.Controllers.ProjectItemSummary>;
            if (itemSummary != null && itemSummary.Any())
            {
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6 class="mb-2"><i class="bi bi-box-seam"></i> Item-wise Purchase & Sale Summary</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Item Name</th>
                                        <th class="text-center">Total Purchased (Qty)</th>
                                        <th class="text-end">Total Purchase Amount</th>
                                        <th class="text-center">Total Sold (Qty)</th>
                                        <th class="text-end">Total Sale Amount</th>
                                        <th class="text-center">Stock Balance (Qty)</th>
                                        <th class="text-end">Stock Balance (Value)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in itemSummary)
                                    {
                                        <tr>
                                            <td>@item.ItemName</td>
                                            <td class="text-center">@item.PurchaseQty.ToString("N2") @item.Unit</td>
                                            <td class="text-end">Rs. @string.Format("{0:N0}", item.PurchaseAmount)</td>
                                            <td class="text-center">@item.SaleQty.ToString("N2") @item.Unit</td>
                                            <td class="text-end">Rs. @string.Format("{0:N0}", item.SaleAmount)</td>
                                            <td class="text-center fw-bold @(item.StockQty > 0 ? "text-success" : item.StockQty < 0 ? "text-danger" : "")">
                                                @item.StockQty.ToString("N2") @item.Unit
                                            </td>
                                            <td class="text-end fw-bold @(item.StockValue > 0 ? "text-success" : item.StockValue < 0 ? "text-danger" : "")">
                                                Rs. @string.Format("{0:N0}", item.StockValue)
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot class="table-secondary">
                                    <tr>
                                        <th>Total</th>
                                        <th class="text-center">-</th>
                                        <th class="text-end">Rs. @string.Format("{0:N0}", itemSummary.Sum(i => i.PurchaseAmount))</th>
                                        <th class="text-center">-</th>
                                        <th class="text-end">Rs. @string.Format("{0:N0}", itemSummary.Sum(i => i.SaleAmount))</th>
                                        <th class="text-center">-</th>
                                        <th class="text-end">Rs. @string.Format("{0:N0}", itemSummary.Sum(i => i.StockValue))</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Transaction Details</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-sm" id="plReportTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Transaction No</th>
                        <th>Type</th>
                        <th>Customer/Item</th>
                        <th>Description</th>
                        <th class="text-end">Debit (Expense)</th>
                        <th class="text-end">Credit (Revenue)</th>
                        <th class="text-end">Running Balance</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal runningBalance = 0;
                        if (vouchers != null)
                        {
                            foreach (var voucher in vouchers.OrderBy(v => v.VoucherDate))
                            {
                                bool isRevenue = voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Sale ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.CashReceived;
                                bool isExpense = voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Purchase ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Expense ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.CashPaid ||
                                voucher.VoucherType == VoucherManagementSystem.Models.VoucherType.Hazri;

                                if (isRevenue)
                                    runningBalance += voucher.Amount;
                                else if (isExpense)
                                    runningBalance -= voucher.Amount;

                                <tr>
                                    <td>@voucher.VoucherDate.ToString("dd-MMM-yy")</td>
                                    <td>
                                        <a asp-controller="Vouchers" asp-action="Details" asp-route-id="@voucher.Id">
                                            @voucher.TransactionNumber
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">@voucher.VoucherType</span>
                                    </td>
                                    <td>
                                        @(voucher.PurchasingCustomer?.Name ?? voucher.ReceivingCustomer?.Name ?? "-")
                                        @if (voucher.Item != null)
                                        {
                                            <br />

                                            <small class="text-muted">@voucher.Item.Name</small>
                                        }
                                    </td>
                                    <td>
                                        @(voucher.Item?.Name ?? voucher.ExpenseHead?.Name ??
                                        voucher.PurchasingCustomerDetails ?? voucher.ReceivingCustomerDetails ??
                                        "Cash Transaction")
                                    </td>
                                    <td class="text-end">
                                        @if (isExpense)
                                        {
                                            <span class="text-danger">@string.Format("{0:N0}", voucher.Amount)</span>
                                        }
                                    </td>
                                    <td class="text-end">
                                        @if (isRevenue)
                                        {
                                            <span class="text-success">@string.Format("{0:N0}", voucher.Amount)</span>
                                        }
                                    </td>
                                    <td class="text-end fw-bold @(runningBalance >= 0 ? "text-success" : "text-danger")">
                                        @string.Format("{0:N0}", runningBalance)
                                    </td>
                                </tr>
                            }
                        }
                    }
                </tbody>
                <tfoot>
                    <tr class="table-dark">
                        <th colspan="5">Total</th>
                        <th class="text-end">@string.Format("{0:N0}", expenses)</th>
                        <th class="text-end">@string.Format("{0:N0}", revenue)</th>
                        <th class="text-end">@string.Format("{0:N0}", profitLoss)</th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<div class="mt-3 d-print-none">
    <button onclick="window.print()" class="btn btn-primary">
        <i class="bi bi-printer"></i> Print Report
    </button>
    <button onclick="exportTableToExcel('plReportTable', 'ProfitLoss_@project?.Name')" class="btn btn-success">
        <i class="bi bi-file-earmark-excel"></i> Export to Excel
    </button>
    <a asp-action="Index" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Back to Reports
    </a>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#plReportTable').DataTable({
                "order": [[0, "asc"]],
                "pageLength": 50,
                "dom": 'Bfrtip',
                "buttons": ['copy', 'csv', 'excel', 'pdf', 'print']
            });
        });

        function exportTableToExcel(tableID, filename = ''){
            var downloadLink;
            var dataType = 'application/vnd.ms-excel';
            var tableSelect = document.getElementById(tableID);
            var tableHTML = tableSelect.outerHTML.replace(/ /g, '%20');

            filename = filename?filename+'.xls':'excel_data.xls';
            downloadLink = document.createElement("a");
            document.body.appendChild(downloadLink);

            if(navigator.msSaveOrOpenBlob){
                var blob = new Blob(['\ufeff', tableHTML], {
                    type: dataType
                });
                navigator.msSaveOrOpenBlob( blob, filename);
            }else{
                downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
                downloadLink.download = filename;
                downloadLink.click();
            }
        }
    </script>

    <style>

            .card

        {
            page-break-inside: avoid;
        }

        .table {
            font-size: 10pt;
        }

    
    </style>
}