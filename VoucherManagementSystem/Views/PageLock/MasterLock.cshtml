@model IEnumerable<VoucherManagementSystem.Models.PageLock>
@{
    ViewData["Title"] = "Master Lock Configuration";
}

<div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Configure page access restrictions. Locked pages will require password authentication.
</div>

<!-- Master Password Section -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0"><i class="bi bi-key-fill"></i> Master Password Settings</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="masterPassword" class="form-label">Set Master Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="masterPassword" placeholder="Enter new master password">
                        <button class="btn btn-outline-secondary toggle-master-password-btn" type="button" title="Show/Hide Password">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-warning" type="button" id="updateMasterPasswordBtn">
                            <i class="bi bi-shield-lock"></i> Update Master Password
                        </button>
                    </div>
                    <div class="form-text">This password is used to access this Master Lock page.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="bi bi-list-check"></i> Page Lock Settings</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="pageLockTable">
                <thead>
                    <tr>
                        <th>Page Name</th>
                        <th>Page URL</th>
                        <th>Status</th>
                        <th>Lock/Unlock</th>
                        <th>Lock Mode</th>
                        <th>Password</th>
                        <th>Last Modified</th>
                        <th>Modified By</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var pageLock in Model)
                    {
                        <tr>
                            <td><strong>@pageLock.PageName</strong></td>
                            <td><code>@pageLock.PageUrl</code></td>
                            <td>
                                <span class="badge bg-@(pageLock.IsLocked ? "danger" : "success")" id="status_@pageLock.Id">
                                    <i class="bi bi-@(pageLock.IsLocked ? "lock" : "unlock")"></i>
                                    @(pageLock.IsLocked ? "Locked" : "Unlocked")
                                </span>
                            </td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input lock-toggle" type="checkbox"
                                           id="toggle_@pageLock.Id"
                                           data-id="@pageLock.Id"
                                           @(pageLock.IsLocked ? "checked" : "")>
                                    <label class="form-check-label" for="toggle_@pageLock.Id">
                                        @(pageLock.IsLocked ? "Locked" : "Unlocked")
                                    </label>
                                </div>
                            </td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input lock-mode-toggle" type="checkbox"
                                           id="lockMode_@pageLock.Id"
                                           data-id="@pageLock.Id"
                                           @(pageLock.LockMode == "JustView" ? "checked" : "")>
                                    <label class="form-check-label" for="lockMode_@pageLock.Id">
                                        <small>@(pageLock.LockMode == "JustView" ? "Just View" : "Login")</small>
                                    </label>
                                </div>
                            </td>
                            <td>
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control form-control-sm password-field"
                                           id="password_@pageLock.Id"
                                           value="@pageLock.Password"
                                           placeholder="Enter password">
                                    <button class="btn btn-outline-secondary btn-sm toggle-password-btn"
                                            type="button"
                                            data-id="@pageLock.Id"
                                            title="Show/Hide Password">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-primary btn-sm update-password-btn"
                                            type="button"
                                            data-id="@pageLock.Id">
                                        <i class="bi bi-key"></i> Update
                                    </button>
                                </div>
                            </td>
                            <td>
                                @if (pageLock.LastModifiedDate.HasValue)
                                {
                                    <small>@pageLock.LastModifiedDate.Value.ToString("dd-MMM-yyyy HH:mm")</small>
                                }
                            </td>
                            <td><small>@pageLock.LastModifiedBy</small></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Password Reset Modal -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-key"></i> Reset Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to update the password for this page?</p>
                <div class="mb-3">
                    <label class="form-label">New Password</label>
                    <input type="text" class="form-control" id="newPassword" placeholder="Enter new password">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmPasswordReset">Update Password</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('#pageLockTable').DataTable({
                "pageLength": 25,
                "order": [[0, "asc"]]
            });

            // Toggle show/hide master password
            $('.toggle-master-password-btn').on('click', function() {
                var passwordField = $('#masterPassword');
                var icon = $(this).find('i');

                if (passwordField.attr('type') === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('bi-eye').addClass('bi-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('bi-eye-slash').addClass('bi-eye');
                }
            });

            // Update master password
            $('#updateMasterPasswordBtn').on('click', function() {
                var password = $('#masterPassword').val();

                if (!password || password.trim() === '') {
                    alert('Please enter a password');
                    return;
                }

                if (confirm('Are you sure you want to update the master password? This will change the password required to access this page.')) {
                    $.ajax({
                        url: '@Url.Action("UpdateMasterPassword", "PageLock")',
                        type: 'POST',
                        data: { password: password },
                        success: function(response) {
                            if (response.success) {
                                showNotification('success', response.message);
                                $('#masterPassword').val(''); // Clear the field
                            } else {
                                alert('Error: ' + response.message);
                            }
                        },
                        error: function() {
                            alert('Error updating master password');
                        }
                    });
                }
            });

            // Toggle lock/unlock
            $('.lock-toggle').on('change', function() {
                var id = $(this).data('id');
                var isChecked = $(this).is(':checked');

                $.ajax({
                    url: '@Url.Action("ToggleLock", "PageLock")',
                    type: 'POST',
                    data: { id: id },
                    success: function(response) {
                        if (response.success) {
                            var statusBadge = $('#status_' + id);
                            if (response.isLocked) {
                                statusBadge.removeClass('bg-success').addClass('bg-danger');
                                statusBadge.html('<i class="bi bi-lock"></i> Locked');
                            } else {
                                statusBadge.removeClass('bg-danger').addClass('bg-success');
                                statusBadge.html('<i class="bi bi-unlock"></i> Unlocked');
                            }

                            // Show success notification
                            showNotification('success', 'Page lock status updated successfully');
                        } else {
                            alert('Error: ' + response.message);
                            // Revert checkbox
                            $('#toggle_' + id).prop('checked', !isChecked);
                        }
                    },
                    error: function() {
                        alert('Error updating lock status');
                        // Revert checkbox
                        $('#toggle_' + id).prop('checked', !isChecked);
                    }
                });
            });

            // Toggle lock mode (Just View / Login)
            $('.lock-mode-toggle').on('change', function() {
                var id = $(this).data('id');
                var isChecked = $(this).is(':checked');
                var lockMode = isChecked ? 'JustView' : 'Login';

                console.log('Lock mode toggle changed:', { id: id, isChecked: isChecked, lockMode: lockMode });

                $.ajax({
                    url: '@Url.Action("UpdateLockMode", "PageLock")',
                    type: 'POST',
                    data: { id: id, lockMode: lockMode },
                    success: function(response) {
                        console.log('Response received:', response);
                        if (response.success) {
                            // Update the label text
                            var label = $('label[for="lockMode_' + id + '"]');
                            label.find('small').text(lockMode === 'JustView' ? 'Just View' : 'Login');

                            // Update the label for attribute text as well
                            label.text(lockMode === 'JustView' ? 'Just View' : 'Login');

                            showNotification('success', 'Lock mode updated to ' + (lockMode === 'JustView' ? 'Just View' : 'Login'));
                        } else {
                            console.error('Update failed:', response.message);
                            alert('Error: ' + response.message);
                            // Revert checkbox
                            $('#lockMode_' + id).prop('checked', !isChecked);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('AJAX error:', { xhr: xhr, status: status, error: error });
                        alert('Error updating lock mode: ' + error);
                        // Revert checkbox
                        $('#lockMode_' + id).prop('checked', !isChecked);
                    }
                });
            });

            // Toggle show/hide password
            $('.toggle-password-btn').on('click', function() {
                var id = $(this).data('id');
                var passwordField = $('#password_' + id);
                var icon = $(this).find('i');

                if (passwordField.attr('type') === 'password') {
                    passwordField.attr('type', 'text');
                    icon.removeClass('bi-eye').addClass('bi-eye-slash');
                } else {
                    passwordField.attr('type', 'password');
                    icon.removeClass('bi-eye-slash').addClass('bi-eye');
                }
            });

            // Update password
            $('.update-password-btn').on('click', function() {
                var id = $(this).data('id');
                var password = $('#password_' + id).val();

                if (!password || password.trim() === '') {
                    alert('Please enter a password');
                    return;
                }

                if (confirm('Are you sure you want to update the password for this page?')) {
                    $.ajax({
                        url: '@Url.Action("UpdatePassword", "PageLock")',
                        type: 'POST',
                        data: {
                            id: id,
                            password: password
                        },
                        success: function(response) {
                            if (response.success) {
                                showNotification('success', response.message);
                            } else {
                                alert('Error: ' + response.message);
                            }
                        },
                        error: function() {
                            alert('Error updating password');
                        }
                    });
                }
            });

            function showNotification(type, message) {
                var bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
                var notification = $('<div class="alert ' + bgClass + ' text-white alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;" role="alert">' +
                    message +
                    '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>' +
                    '</div>');

                $('body').append(notification);

                setTimeout(function() {
                    notification.alert('close');
                }, 3000);
            }
        });
    </script>
}
