@using VoucherManagementSystem.Controllers
@{
    ViewData["Title"] = "Dashboard";
    var totalCapital = (decimal)(ViewBag.TotalCapital ?? 0);
    var totalStockValue = (decimal)(ViewBag.TotalStockValue ?? 0);
    var totalReceivables = (decimal)(ViewBag.TotalReceivables ?? 0);
    var totalPayables = (decimal)(ViewBag.TotalPayables ?? 0);
    var cashInHand = (decimal)(ViewBag.CashInHand ?? 0);
    var totalBankBalance = (decimal)(ViewBag.TotalBankBalance ?? 0);
    var todayAmount = (decimal)(ViewBag.TodayAmount ?? 0);
    var totalExpenses30Days = (decimal)(ViewBag.TotalExpenses30Days ?? 0);

    var stockData = ViewBag.StockData as List<DashboardStockItem> ?? new List<DashboardStockItem>();
    var receivablesData = ViewBag.ReceivablesData as List<DashboardNameAmount> ?? new List<DashboardNameAmount>();
    var payablesData = ViewBag.PayablesData as List<DashboardNameAmount> ?? new List<DashboardNameAmount>();
    var bankData = ViewBag.BankData as List<DashboardBankBalance> ?? new List<DashboardBankBalance>();
    var expenseData = ViewBag.ExpenseData as List<DashboardNameAmount> ?? new List<DashboardNameAmount>();
    var monthlyData = ViewBag.MonthlyData as List<DashboardMonthlyData> ?? new List<DashboardMonthlyData>();
    var voucherTypeData = ViewBag.VoucherTypeData as List<DashboardVoucherType> ?? new List<DashboardVoucherType>();
}

<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-0"><i class="bi bi-speedometer2"></i> Dashboard</h2>
        <small class="text-muted">Welcome to Al Hafiz Store Management System</small>
    </div>
    <div class="text-end">
        <span class="badge bg-dark fs-6"><i class="bi bi-calendar"></i> @DateTime.Now.ToString("dddd, dd MMM yyyy")</span>
    </div>
</div>

<!-- Total Capital Banner -->
<div class="card bg-gradient mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div class="card-body text-white py-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h6 class="text-white-50 mb-1">TOTAL CAPITAL</h6>
                <h1 class="display-4 fw-bold mb-0">Rs. @string.Format("{0:N0}", totalCapital)</h1>
                <small class="text-white-50">Stock + Receivables + Cash + Bank - Payables</small>
            </div>
            <div class="col-md-4 text-end">
                <i class="bi bi-wallet2" style="font-size: 5rem; opacity: 0.3;"></i>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Row 1 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #28a745 !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Stock Value</h6>
                        <h3 class="mb-0 text-success">Rs. @string.Format("{0:N0}", totalStockValue)</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-box-seam text-success fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #17a2b8 !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Receivables</h6>
                        <h3 class="mb-0 text-info">Rs. @string.Format("{0:N0}", totalReceivables)</h3>
                    </div>
                    <div class="bg-info bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-arrow-down-circle text-info fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #dc3545 !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Payables</h6>
                        <h3 class="mb-0 text-danger">Rs. @string.Format("{0:N0}", totalPayables)</h3>
                    </div>
                    <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-arrow-up-circle text-danger fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #ffc107 !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Cash in Hand</h6>
                        <h3 class="mb-0 text-warning">Rs. @string.Format("{0:N0}", cashInHand)</h3>
                    </div>
                    <div class="bg-warning bg-opacity-10 rounded-circle p-3">
                        <i class="bi bi-cash-stack text-warning fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Row 2 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #6f42c1 !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Bank Balance</h6>
                        <h3 class="mb-0" style="color: #6f42c1;">Rs. @string.Format("{0:N0}", totalBankBalance)</h3>
                    </div>
                    <div class="rounded-circle p-3" style="background-color: rgba(111, 66, 193, 0.1);">
                        <i class="bi bi-bank fs-4" style="color: #6f42c1;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #fd7e14 !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Today's Amount</h6>
                        <h3 class="mb-0" style="color: #fd7e14;">Rs. @string.Format("{0:N0}", todayAmount)</h3>
                        <small class="text-muted">@ViewBag.TodayTransactions transactions</small>
                    </div>
                    <div class="rounded-circle p-3" style="background-color: rgba(253, 126, 20, 0.1);">
                        <i class="bi bi-calendar-day fs-4" style="color: #fd7e14;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #20c997 !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Total Vouchers</h6>
                        <h3 class="mb-0" style="color: #20c997;">@ViewBag.TotalVouchers</h3>
                        <small class="text-muted">@ViewBag.ActiveProjects projects</small>
                    </div>
                    <div class="rounded-circle p-3" style="background-color: rgba(32, 201, 151, 0.1);">
                        <i class="bi bi-receipt fs-4" style="color: #20c997;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm h-100" style="border-left: 4px solid #e83e8c !important;">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Expenses (30 Days)</h6>
                        <h3 class="mb-0" style="color: #e83e8c;">Rs. @string.Format("{0:N0}", totalExpenses30Days)</h3>
                    </div>
                    <div class="rounded-circle p-3" style="background-color: rgba(232, 62, 140, 0.1);">
                        <i class="bi bi-graph-down fs-4" style="color: #e83e8c;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Capital Distribution Doughnut -->
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Capital Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="capitalChart" height="250"></canvas>
            </div>
        </div>
    </div>

    <!-- Monthly Trend Chart -->
    <div class="col-md-8">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Monthly Trends (Last 6 Months)</h6>
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="125"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Second Charts Row -->
<div class="row mb-4">
    <!-- Expense by Head -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Expenses by Head (30 Days)</h6>
            </div>
            <div class="card-body">
                <canvas id="expenseChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Voucher Type Distribution -->
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white border-0">
                <h6 class="mb-0"><i class="bi bi-diagram-3"></i> Voucher Type Distribution</h6>
            </div>
            <div class="card-body">
                <canvas id="voucherTypeChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row mb-4">
    <!-- Top Receivables -->
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="bi bi-arrow-down-circle"></i> Top Receivables</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Customer</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in receivablesData)
                            {
                                <tr>
                                    <td>@item.Name</td>
                                    <td class="text-end text-success fw-bold">Rs. @string.Format("{0:N0}", item.Amount)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white">
                <a asp-controller="Reports" asp-action="AllCustomersReport" class="btn btn-sm btn-outline-success w-100">View All</a>
            </div>
        </div>
    </div>

    <!-- Top Payables -->
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-danger text-white">
                <h6 class="mb-0"><i class="bi bi-arrow-up-circle"></i> Top Payables</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Supplier</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in payablesData)
                            {
                                <tr>
                                    <td>@item.Name</td>
                                    <td class="text-end text-danger fw-bold">Rs. @string.Format("{0:N0}", item.Amount)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white">
                <a asp-controller="Reports" asp-action="AllCustomersReport" class="btn btn-sm btn-outline-danger w-100">View All</a>
            </div>
        </div>
    </div>

    <!-- Stock Items -->
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-box-seam"></i> Stock Items</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Item</th>
                                <th class="text-end">Qty</th>
                                <th class="text-end">Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in stockData)
                            {
                                <tr>
                                    <td>@item.Name</td>
                                    <td class="text-end">@string.Format("{0:N0}", item.Quantity)</td>
                                    <td class="text-end text-primary fw-bold">Rs. @string.Format("{0:N0}", item.Value)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white">
                <a asp-controller="Reports" asp-action="CapitalReport" class="btn btn-sm btn-outline-primary w-100">View Capital Report</a>
            </div>
        </div>
    </div>
</div>

<!-- Bank Balances & Recent Transactions -->
<div class="row mb-4">
    <!-- Bank Balances -->
    <div class="col-md-4">
        <div class="card shadow-sm h-100">
            <div class="card-header text-white" style="background-color: #6f42c1;">
                <h6 class="mb-0"><i class="bi bi-bank"></i> Bank Accounts</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Bank</th>
                                <th class="text-end">Balance</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var bank in bankData)
                            {
                                <tr>
                                    <td>@bank.Name</td>
                                    <td class="text-end fw-bold @(bank.Balance >= 0 ? "text-success" : "text-danger")">
                                        Rs. @string.Format("{0:N0}", bank.Balance)
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th>Total</th>
                                <th class="text-end">Rs. @string.Format("{0:N0}", totalBankBalance)</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="col-md-8">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0"><i class="bi bi-clock-history"></i> Recent Transactions</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Date</th>
                                <th>Transaction #</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ViewBag.RecentVouchers != null)
                            {
                                foreach (var v in ViewBag.RecentVouchers)
                                {
                                    var customer = v.PurchasingCustomer?.Name ?? v.ReceivingCustomer?.Name ?? v.PurchasingCustomerDetails ?? v.ReceivingCustomerDetails ?? "-";
                                    <tr>
                                        <td>@v.VoucherDate.ToString("dd-MMM")</td>
                                        <td>
                                            <a asp-controller="Vouchers" asp-action="Details" asp-route-id="@v.Id">@v.TransactionNumber</a>
                                        </td>
                                        <td>
                                            <span class="badge bg-@GetVoucherColor(v.VoucherType.ToString())">@v.VoucherType</span>
                                        </td>
                                        <td>@(customer.Length > 20 ? customer.Substring(0, 20) + "..." : customer)</td>
                                        <td class="text-end fw-bold">Rs. @string.Format("{0:N0}", v.Amount)</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-white">
                <a asp-controller="Vouchers" asp-action="Index" class="btn btn-sm btn-outline-dark w-100">View All Vouchers</a>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h6 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="row g-2">
                    <div class="col-md-2">
                        <a asp-controller="Vouchers" asp-action="Create" asp-route-type="Purchase" class="btn btn-success w-100">
                            <i class="bi bi-cart-plus"></i> New Purchase
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a asp-controller="Vouchers" asp-action="Create" asp-route-type="Sale" class="btn btn-warning w-100">
                            <i class="bi bi-cart-check"></i> New Sale
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a asp-controller="Vouchers" asp-action="Create" asp-route-type="Expense" class="btn btn-danger w-100">
                            <i class="bi bi-receipt"></i> New Expense
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a asp-controller="Vouchers" asp-action="Create" asp-route-type="CashReceived" class="btn btn-info w-100">
                            <i class="bi bi-cash"></i> Cash Received
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a asp-controller="Vouchers" asp-action="Create" asp-route-type="CashPaid" class="btn btn-secondary w-100">
                            <i class="bi bi-cash-coin"></i> Cash Paid
                        </a>
                    </div>
                    <div class="col-md-2">
                        <a asp-controller="Reports" asp-action="Index" class="btn btn-primary w-100">
                            <i class="bi bi-graph-up"></i> Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetVoucherColor(string type)
    {
        return type switch
        {
            "Purchase" => "success",
            "Sale" => "warning",
            "Expense" => "danger",
            "Hazri" => "info",
            "CashPaid" => "secondary",
            "CashReceived" => "primary",
            "CCR" => "dark",
            "BCR" => "dark",
            _ => "secondary"
        };
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Capital Distribution Chart
        new Chart(document.getElementById('capitalChart'), {
            type: 'doughnut',
            data: {
                labels: ['Stock', 'Receivables', 'Cash', 'Bank', 'Payables'],
                datasets: [{
                    data: [@totalStockValue, @totalReceivables, @Math.Max(0, cashInHand), @Math.Max(0, totalBankBalance), @totalPayables],
                    backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1', '#dc3545'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { boxWidth: 12 } }
                },
                cutout: '60%'
            }
        });

        // Monthly Trend Chart
        var monthlyDataJson = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(monthlyData));
        new Chart(document.getElementById('monthlyChart'), {
            type: 'line',
            data: {
                labels: monthlyDataJson.map(d => d.Month),
                datasets: [
                    {
                        label: 'Sales',
                        data: monthlyDataJson.map(d => d.Sales),
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Purchases',
                        data: monthlyDataJson.map(d => d.Purchases),
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Expenses',
                        data: monthlyDataJson.map(d => d.Expenses),
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { beginAtZero: true, ticks: { callback: function(value) { return 'Rs. ' + value.toLocaleString(); } } }
                }
            }
        });

        // Expense by Head Chart
        var expenseDataJson = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(expenseData));
        new Chart(document.getElementById('expenseChart'), {
            type: 'bar',
            data: {
                labels: expenseDataJson.map(d => d.Name),
                datasets: [{
                    label: 'Amount',
                    data: expenseDataJson.map(d => d.Amount),
                    backgroundColor: [
                        '#dc3545', '#e83e8c', '#fd7e14', '#ffc107', '#28a745',
                        '#20c997', '#17a2b8', '#6f42c1', '#6610f2', '#343a40'
                    ],
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true, ticks: { callback: function(value) { return 'Rs. ' + value.toLocaleString(); } } }
                }
            }
        });

        // Voucher Type Chart
        var voucherTypeDataJson = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(voucherTypeData));
        new Chart(document.getElementById('voucherTypeChart'), {
            type: 'polarArea',
            data: {
                labels: voucherTypeDataJson.map(d => d.Type),
                datasets: [{
                    data: voucherTypeDataJson.map(d => d.Amount),
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(255, 193, 7, 0.7)',
                        'rgba(220, 53, 69, 0.7)',
                        'rgba(23, 162, 184, 0.7)',
                        'rgba(108, 117, 125, 0.7)',
                        'rgba(0, 123, 255, 0.7)',
                        'rgba(111, 66, 193, 0.7)',
                        'rgba(52, 58, 64, 0.7)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'right', labels: { boxWidth: 12 } } }
            }
        });
    </script>
}
