@* Views/Vouchers/Edit.cshtml - ENHANCED VERSION *@
@model VoucherManagementSystem.Models.Voucher
@{
    ViewData["Title"] = "Edit Voucher";
}

<h2><i class="bi bi-pencil-square"></i> Edit @Model.VoucherType Voucher</h2>

<div class="card">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">Transaction: @Model.TransactionNumber</h5>
    </div>
    <div class="card-body">
        <form asp-action="Edit" method="post" id="voucherEditForm">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="TransactionNumber" />
            <input type="hidden" asp-for="VoucherType" />
            <input type="hidden" asp-for="CreatedDate" />
            <input type="hidden" asp-for="CreatedBy" />

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label asp-for="TransactionNumber" class="form-label">Transaction Number</label>
                    <input asp-for="TransactionNumber" class="form-control" readonly />
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="VoucherDate" class="form-label">Voucher Date</label>
                    <input asp-for="VoucherDate" type="date" class="form-control" />
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="CashType" class="form-label">Cash Type</label>
                    <select asp-for="CashType" class="form-select" id="cashType">
                        <option value="">Select Type</option>
                        @foreach (var type in Enum.GetValues<VoucherManagementSystem.Models.CashType>())
                        {
                            <option value="@type">@type</option>
                        }
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="ProjectId" class="form-label">Project</label>
                    @Html.DropDownListFor(m => m.ProjectId, ViewBag.Projects as SelectList, "Select Project", new { @class = "form-select" })
                </div>
            </div>

            <div class="row" id="purchasingCustomerSection">
                <div class="col-md-4 mb-3">
                    <label asp-for="PurchasingCustomerId" class="form-label">Purchasing Customer</label>
                    @Html.DropDownListFor(m => m.PurchasingCustomerId, ViewBag.Customers as SelectList, "Select Customer", new { @class = "form-select", id = "purchasingCustomer" })
                </div>
                <div class="col-md-8 mb-3">
                    <label asp-for="PurchasingCustomerDetails" class="form-label">Purchasing Customer Details</label>
                    <input asp-for="PurchasingCustomerDetails" class="form-control" />
                </div>
            </div>

            <div class="row" id="receivingCustomerSection" style="display:none;">
                <div class="col-md-4 mb-3">
                    <label asp-for="ReceivingCustomerId" class="form-label">Receiving Customer</label>
                    @Html.DropDownListFor(m => m.ReceivingCustomerId, ViewBag.Customers as SelectList, "Select Customer", new { @class = "form-select", id = "receivingCustomer" })
                </div>
                <div class="col-md-8 mb-3">
                    <label asp-for="ReceivingCustomerDetails" class="form-label">Receiving Customer Details</label>
                    <input asp-for="ReceivingCustomerDetails" class="form-control" />
                </div>
            </div>

            <div class="row" id="bankSection" style="display:none;">
                <div class="col-md-3 mb-3">
                    <label asp-for="BankCustomerPaidId" class="form-label">Bank Customer Paid</label>
                    @Html.DropDownListFor(m => m.BankCustomerPaidId, ViewBag.Banks as SelectList, "Select Bank", new { @class = "form-select" })
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="BankCustomerPaidDetails" class="form-label">Bank Paid Details</label>
                    <input asp-for="BankCustomerPaidDetails" class="form-control" />
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="BankCustomerReceiverId" class="form-label">Bank Customer Receiver</label>
                    @Html.DropDownListFor(m => m.BankCustomerReceiverId, ViewBag.Banks as SelectList, "Select Bank", new { @class = "form-select" })
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="BankCustomerReceiverDetails" class="form-label">Bank Receiver Details</label>
                    <input asp-for="BankCustomerReceiverDetails" class="form-control" />
                </div>
            </div>

            <div class="row" id="itemSection">
                <div class="col-md-2 mb-3">
                    <label asp-for="ItemId" class="form-label">Item</label>
                    @Html.DropDownListFor(m => m.ItemId, ViewBag.Items as SelectList, "Select Item", new { @class = "form-select", id = "itemSelect" })
                </div>
                <div class="col-md-2 mb-3">
                    <label asp-for="Mon" class="form-label">
                        Mon <small class="text-muted">(×40=Weight)</small>
                    </label>
                    <input asp-for="Mon" class="form-control" id="mon" type="number" step="0.001" />
                </div>
                <div class="col-md-2 mb-3">
                    <label asp-for="Weight" class="form-label">
                        Weight <small class="text-muted">(Auto)</small>
                    </label>
                    <input asp-for="Weight" type="number" step="0.001" class="form-control" id="weight" />
                </div>
                <div class="col-md-2 mb-3">
                    <label asp-for="Kat" class="form-label">
                        Kat <small class="text-muted">(Deduction)</small>
                    </label>
                    <input asp-for="Kat" type="number" step="0.001" class="form-control" id="kat" value="0" />
                </div>
                <div class="col-md-2 mb-3">
                    <label asp-for="Quantity" class="form-label">
                        Qty <small class="text-muted">(W-K)</small>
                    </label>
                    <input asp-for="Quantity" type="number" step="0.001" class="form-control" id="quantity" />
                </div>
                <div class="col-md-2 mb-3">
                    <label asp-for="Rate" class="form-label">
                        Rate <small class="text-muted">(Auto)</small>
                    </label>
                    <input asp-for="Rate" type="number" step="0.01" class="form-control" id="rate" />
                </div>
            </div>

            <div class="row" id="expenseSection" style="display:none;">
                <div class="col-md-4 mb-3">
                    <label asp-for="ExpenseHeadId" class="form-label">Expense Head</label>
                    @Html.DropDownListFor(m => m.ExpenseHeadId, ViewBag.ExpenseHeads as SelectList, "Select Expense Head", new { @class = "form-select", id = "expenseHead" })
                </div>
                <div class="col-md-2 mb-3">
                    <label asp-for="ExpenseHeadRate" class="form-label">Expense Head Rate</label>
                    <input asp-for="ExpenseHeadRate" type="number" step="0.01" class="form-control" />
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="ExpenseHeadDetails" class="form-label">Expense Head Details</label>
                    <input asp-for="ExpenseHeadDetails" class="form-control" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label asp-for="Amount" class="form-label">
                        Amount <small class="text-muted">(Qty×Rate)</small>
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">Rs.</span>
                        <input asp-for="Amount" type="number" step="0.01" class="form-control" id="amount" />
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="GariNo" class="form-label">Gari No.</label>
                    <input asp-for="GariNo" class="form-control" placeholder="Vehicle Number" />
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">Options</label>
                    <div class="form-check mt-2">
                        <input asp-for="StockInclude" class="form-check-input" type="checkbox" id="stockInclude" />
                        <label class="form-check-label" for="stockInclude">
                            Include in Stock
                        </label>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="Status" class="form-label">Status</label>
                    <select asp-for="Status" class="form-select">
                        @foreach (var status in Enum.GetValues<VoucherManagementSystem.Models.TransactionStatus>())
                        {
                            <option value="@status">@status</option>
                        }
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info">
                        <strong>Calculation Formula:</strong>
                        Mon × 40 = Weight | Weight - Kat = Quantity | Quantity × Rate = Amount
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-save"></i> Update Voucher
                    </button>
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-info">
                        <i class="bi bi-eye"></i> View Details
                    </a>
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            var voucherType = '@Model.VoucherType';
            configureFormForVoucherType(voucherType);

            // Handle cash type change
            $('#cashType').on('change', function() {
                if ($(this).val() == 'Bank') {
                    $('#bankSection').show();
                } else {
                    $('#bankSection').hide();
                }
            });

            // MON calculation: Mon * 40 = Weight, Kat = 0
            $('#mon').on('input', function() {
                var mon = parseFloat($(this).val()) || 0;
                var weight = mon * 40;
                $('#weight').val(weight.toFixed(3));
                $('#kat').val(0);
                calculateQuantity();
            });

            // Weight or Kat change: Weight - Kat = Quantity
            $('#weight, #kat').on('input', function() {
                calculateQuantity();
            });

            // Calculate quantity
            function calculateQuantity() {
                var weight = parseFloat($('#weight').val()) || 0;
                var kat = parseFloat($('#kat').val()) || 0;
                var quantity = weight - kat;
                $('#quantity').val(quantity.toFixed(3));
                calculateAmount();
            }

            // Quantity or Rate change: Quantity * Rate = Amount
            $('#quantity, #rate').on('input', function() {
                calculateAmount();
            });

            function calculateAmount() {
                var qty = parseFloat($('#quantity').val()) || 0;
                var rate = parseFloat($('#rate').val()) || 0;
                var amount = qty * rate;
                $('#amount').val(amount.toFixed(2));
            }

            // Get item rate for customer (for Sales - Receiving Customer)
            $('#itemSelect, #receivingCustomer').on('change', function() {
                var itemId = $('#itemSelect').val();
                var customerId = $('#receivingCustomer').val();

                if (voucherType == 'Sale' && itemId && customerId) {
                    $.get('/Vouchers/GetItemRate', { itemId: itemId, customerId: customerId }, function(data) {
                        $('#rate').val(data.rate);
                        calculateAmount();
                    });
                }
            });

            // Get item rate for customer (for Purchase - Purchasing Customer)
            $('#itemSelect, #purchasingCustomer').on('change', function() {
                var itemId = $('#itemSelect').val();
                var customerId = $('#purchasingCustomer').val();

                if (voucherType == 'Purchase' && itemId && customerId) {
                    $.get('/Vouchers/GetItemRate', { itemId: itemId, customerId: customerId }, function(data) {
                        $('#rate').val(data.rate);
                        calculateAmount();
                    });
                }
            });

            // Initialize calculations on load
            if ($('#mon').val()) {
                $('#mon').trigger('input');
            }
        });

        function configureFormForVoucherType(type) {
            // Reset all sections
            $('#purchasingCustomerSection, #receivingCustomerSection, #bankSection, #itemSection, #expenseSection').hide();

            switch(type) {
                case 'Purchase':
                    $('#purchasingCustomerSection, #itemSection, #expenseSection').show();
                    $('#stockInclude').parent().show();
                    break;
                case 'Sale':
                    $('#receivingCustomerSection, #itemSection, #expenseSection').show();
                    $('#stockInclude').parent().hide();
                    break;
                case 'Expense':
                    $('#expenseSection').show();
                    break;
                case 'Hazri':
                    $('#expenseSection, #itemSection').show();
                    break;
                case 'CashPaid':
                    $('#purchasingCustomerSection').show();
                    break;
                case 'CashReceived':
                    $('#receivingCustomerSection').show();
                    break;
                case 'CCR':
                    $('#purchasingCustomerSection, #receivingCustomerSection').show();
                    break;
                case 'BCR':
                    $('#bankSection').show();
                    break;
            }
        }
    </script>
}