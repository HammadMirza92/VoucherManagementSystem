@* Views/Vouchers/Create.cshtml *@
@model VoucherManagementSystem.Models.Voucher
@{
    ViewData["Title"] = "Create Voucher";
    var voucherList = ViewBag.VoucherList as List<VoucherManagementSystem.Models.Voucher>;
}

@section Styles {
    <style>
        /* Label styling for voucher forms */
        #voucherForm label,
        #voucherForm .form-label {
            background-color: #9b0000;
            color: white;
            padding: 8px;
            border-radius: 3px;
            display: block;
            margin-bottom: 2px;
            font-weight: normal;
            text-align: center;
            width: 100%;
            font-size: calc(1rem + 2px);
        }
    </style>
}

<h2><i class="bi bi-plus-circle"></i> Create New @Model.VoucherType Voucher</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Voucher List Section -->
<div class="card mb-3">
    <div class="card-header">
        <h5>Recent @Model.VoucherType Vouchers (Total: @ViewBag.TotalRecords)</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>Transaction No</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Item</th>
                        <th>Project</th>
                        <th>Quantity</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (voucherList != null && voucherList.Any())
                    {
                        @foreach (var item in voucherList)
                        {
                            <tr>
                                <td>@item.TransactionNumber</td>
                                <td>@item.VoucherDate.ToString("dd-MMM-yyyy")</td>
                                <td>
                                    @{
                                        var customerName = item.PurchasingCustomer?.Name ?? item.ReceivingCustomer?.Name;
                                    }
                                    @customerName
                                </td>
                                <td>@item.Item?.Name</td>
                                <td>@item.Project?.Name</td>
                                <td class="text-end">@(item.Quantity.HasValue ? string.Format("{0:N3}", item.Quantity.Value) : "-")</td>
                                <td class="text-end">@(item.Rate.HasValue ? string.Format("{0:N2}", item.Rate.Value) : "-")</td>
                                <td class="text-end">@string.Format("{0:N0}", item.Amount)</td>
                                <td>
                                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-info" title="Details">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center">No vouchers found for this type.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (ViewBag.TotalPages > 1)
        {
            <nav aria-label="Voucher pagination">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                        <a class="page-link" asp-action="Create" asp-route-type="@Model.VoucherType" asp-route-page="@(ViewBag.CurrentPage - 1)">Previous</a>
                    </li>

                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(ViewBag.CurrentPage == i ? "active" : "")">
                            <a class="page-link" asp-action="Create" asp-route-type="@Model.VoucherType" asp-route-page="@i">@i</a>
                        </li>
                    }

                    <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                        <a class="page-link" asp-action="Create" asp-route-type="@Model.VoucherType" asp-route-page="@(ViewBag.CurrentPage + 1)">Next</a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</div>

<!-- Create Form Section -->
<div class="card">
    <div class="card-header">
        <h5>Add New @Model.VoucherType Voucher</h5>
    </div>
    <div class="card-body">
        <form asp-action="Create" id="voucherForm">
            <input type="hidden" asp-for="VoucherType" />

            <!-- Transaction Number and Date on top -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <label asp-for="TransactionNumber" class="form-label"><strong>Transaction Number</strong></label>
                    <input asp-for="TransactionNumber" class="form-control" readonly />
                </div>
                <div class="col-md-3">
                    <label asp-for="VoucherDate" class="form-label"><strong>Voucher Date</strong></label>
                    <input asp-for="VoucherDate" type="date" class="form-control" />
                </div>
            </div>

            <!-- Single Row Layout with Multiple Sub-rows -->
            <div class="table-responsive">
                <table class="table table-bordered" style="table-layout: auto; white-space: nowrap;">
                    <tbody>
                        <tr>
                            <!-- Column 1: Project & Cash Type -->
                            <td id="projectCashTypeColumn" style="vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr id="projectRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="ProjectId" class="form-label mb-1" style="font-size: 0.85rem;">Project</label>
                                            @Html.DropDownListFor(m => m.ProjectId, ViewBag.Projects as SelectList, "Select Project", new { @class = "form-select form-select-sm" })
                                        </td>
                                    </tr>
                                    <tr id="cashTypeRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="CashType" class="form-label mb-1" style="font-size: 0.85rem;">Cash Type</label>
                                            <select asp-for="CashType" class="form-select form-select-sm" id="cashType">
                                                <option value="">Select Type</option>
                                                @foreach (var type in Enum.GetValues<VoucherManagementSystem.Models.CashType>())
                                                {
                                                    <option value="@type">@type</option>
                                                }
                                            </select>
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 2: Bank Details (shown when Cash Type = Bank) -->
                            <td id="bankColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr id="bankPaidRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="BankCustomerPaidId" class="form-label mb-1" style="font-size: 0.85rem;">Bank Paid</label>
                                            @Html.DropDownListFor(m => m.BankCustomerPaidId, ViewBag.Banks as SelectList, "Select Bank", new { @class = "form-select form-select-sm" })
                                        </td>
                                    </tr>
                                    <tr id="bankPaidDetailsRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="BankCustomerPaidDetails" class="form-label mb-1" style="font-size: 0.85rem;">Bank Paid Details</label>
                                            <input asp-for="BankCustomerPaidDetails" class="form-control form-control-sm" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 2b: Bank Receiver (for certain voucher types) -->
                            <td id="bankReceiverColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr id="bankReceiverRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="BankCustomerReceiverId" class="form-label mb-1" style="font-size: 0.85rem;">Bank Receiver</label>
                                            @Html.DropDownListFor(m => m.BankCustomerReceiverId, ViewBag.Banks as SelectList, "Select Bank", new { @class = "form-select form-select-sm" })
                                        </td>
                                    </tr>
                                    <tr id="bankReceiverDetailsRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="BankCustomerReceiverDetails" class="form-label mb-1" style="font-size: 0.85rem;">Bank Receiver Details</label>
                                            <input asp-for="BankCustomerReceiverDetails" class="form-control form-control-sm" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 3: Purchasing Customer -->
                            <td id="purchasingCustomerColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="PurchasingCustomerId" class="form-label mb-1" style="font-size: 0.85rem;">Purchasing Customer</label>
                                            <div class="input-group input-group-sm">
                                                @Html.DropDownListFor(m => m.PurchasingCustomerId, ViewBag.Customers as SelectList, "Select Customer", new { @class = "form-select form-select-sm", id = "purchasingCustomer" })
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="copyPurchasingCustomerName" title="Copy">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="PurchasingCustomerDetails" class="form-label mb-1" style="font-size: 0.85rem;">Customer Details</label>
                                            <input asp-for="PurchasingCustomerDetails" class="form-control form-control-sm" id="purchasingCustomerDetails" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 4: Receiving Customer -->
                            <td id="receivingCustomerColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="ReceivingCustomerId" class="form-label mb-1" style="font-size: 0.85rem;">Receiving Customer</label>
                                            <div class="input-group input-group-sm">
                                                @Html.DropDownListFor(m => m.ReceivingCustomerId, ViewBag.Customers as SelectList, "Select Customer", new { @class = "form-select form-select-sm", id = "receivingCustomer" })
                                                <button type="button" class="btn btn-outline-secondary btn-sm" id="copyReceivingCustomerName" title="Copy">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="ReceivingCustomerDetails" class="form-label mb-1" style="font-size: 0.85rem;">Customer Details</label>
                                            <input asp-for="ReceivingCustomerDetails" class="form-control form-control-sm" id="receivingCustomerDetails" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 5: Item -->
                            <td id="itemColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <label asp-for="ItemId" class="form-label mb-1" style="font-size: 0.85rem;">Item</label>
                                @Html.DropDownListFor(m => m.ItemId, ViewBag.Items as SelectList, "Select Item", new { @class = "form-select form-select-sm", id = "itemSelect" })
                            </td>

                            <!-- Column 6: Mon & Weight -->
                            <td id="monWeightColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="Mon" class="form-label mb-1" style="font-size: 0.85rem;">Mon</label>
                                            <input asp-for="Mon" class="form-control form-control-sm" id="Mon" type="number" step="0.001" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="Weight" class="form-label mb-1" style="font-size: 0.85rem;">Weight</label>
                                            <input asp-for="Weight" type="number" step="0.001" class="form-control form-control-sm" id="weight" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 7: Kat & Quantity -->
                            <td id="katQuantityColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="Kat" class="form-label mb-1" style="font-size: 0.85rem;">Kat</label>
                                            <input asp-for="Kat" type="number" step="0.001" class="form-control form-control-sm" id="kat" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="Quantity" class="form-label mb-1" style="font-size: 0.85rem;">Quantity</label>
                                            <input asp-for="Quantity" type="number" step="0.001" class="form-control form-control-sm" id="quantity" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 8: Expense Head (3 rows) -->
                            <td id="expenseHeadColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="ExpenseHeadId" class="form-label mb-1" style="font-size: 0.85rem;">Expense Head</label>
                                            @Html.DropDownListFor(m => m.ExpenseHeadId, ViewBag.ExpenseHeads as SelectList, "Select Expense Head", new { @class = "form-select form-select-sm", id = "expenseHead" })
                                        </td>
                                    </tr>
                                    <tr id="expenseRateRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="ExpenseHeadRate" class="form-label mb-1" style="font-size: 0.85rem;">Expense Rate</label>
                                            <input asp-for="ExpenseHeadRate" type="number" step="0.01" class="form-control form-control-sm" id="expenseHeadRate" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="ExpenseHeadDetails" class="form-label mb-1" style="font-size: 0.85rem;">Expense Details</label>
                                            <input asp-for="ExpenseHeadDetails" class="form-control form-control-sm" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 9: Rate & Amount -->
                            <td id="rateAmountColumn" style="vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr id="rateRow">
                                        <td style="padding: 2px;">
                                            <label asp-for="Rate" class="form-label mb-1" style="font-size: 0.85rem;">Rate</label>
                                            <input asp-for="Rate" type="number" step="0.01" class="form-control form-control-sm" id="rate" />
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="Amount" class="form-label mb-1" style="font-size: 0.85rem;">Amount</label>
                                            <input asp-for="Amount" type="number" step="0.01" class="form-control form-control-sm" id="amount" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Column 10: Gari No & Stock -->
                            <td id="gariStockColumn" style="display:none; vertical-align: top; padding: 8px;">
                                <table class="w-100">
                                    <tr>
                                        <td style="padding: 2px;">
                                            <label asp-for="GariNo" class="form-label mb-1" style="font-size: 0.85rem;">Gari No.</label>
                                            <input asp-for="GariNo" class="form-control form-control-sm" />
                                        </td>
                                    </tr>
                                    <tr id="stockIncludeRow">
                                        <td style="padding: 2px;">
                                            <label class="form-label mb-1" style="font-size: 0.85rem;">Stock (0/1)</label>
                                            <input type="text" class="form-control form-control-sm" id="stockIncludeText" value="0" maxlength="1" />
                                            <input type="hidden" name="StockInclude" id="stockInclude" value="false" />
                                        </td>
                                    </tr>
                                </table>
                            </td>

                            <!-- Submit Button Column -->
                            <td style="vertical-align: middle; padding: 8px;">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-check-circle"></i> Save
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="row mt-2">
                <div class="col-12">
                    <a asp-action="Index" class="btn btn-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize Select2 for customer dropdowns with search functionality
            $('#purchasingCustomer, #receivingCustomer').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select Customer',
                allowClear: true,
                width: '100%'
            });

            // Initialize Select2 for item dropdown with search functionality
            $('#itemSelect').select2({
                theme: 'bootstrap-5',
                placeholder: 'Select Item',
                allowClear: true,
                width: '100%'
            });

            // Arrow key navigation between form fields
            var formInputs = 'input:not([readonly]):visible, select:visible, textarea:visible';

            $(document).on('keydown', formInputs, function(e) {
                // Get all visible and enabled form inputs
                var $allInputs = $(formInputs).not(':disabled');
                var currentIndex = $allInputs.index(this);

                // Arrow Right - Move to next field
                if (e.keyCode === 39) {
                    e.preventDefault();
                    if (currentIndex < $allInputs.length - 1) {
                        var $nextInput = $allInputs.eq(currentIndex + 1);
                        // If next input is a Select2, open it
                        if ($nextInput.hasClass('select2-hidden-accessible')) {
                            $nextInput.select2('open');
                        } else {
                            $nextInput.focus().select();
                        }
                    }
                }

                // Arrow Left - Move to previous field
                if (e.keyCode === 37) {
                    e.preventDefault();
                    if (currentIndex > 0) {
                        var $prevInput = $allInputs.eq(currentIndex - 1);
                        // If previous input is a Select2, open it
                        if ($prevInput.hasClass('select2-hidden-accessible')) {
                            $prevInput.select2('open');
                        } else {
                            $prevInput.focus().select();
                        }
                    }
                }
            });

            // Stock Include text to checkbox conversion
            $('#stockIncludeText').on('input', function() {
                var value = $(this).val();
                if (value === '1') {
                    $('#stockInclude').val('true');
                    $(this).val('1');
                } else {
                    $('#stockInclude').val('false');
                    $(this).val('0');
                }
            });

            // On form submit, ensure stockInclude hidden field is set correctly
            $('#voucherForm').on('submit', function(e) {
                var value = $('#stockIncludeText').val();
                $('#stockInclude').val(value === '1' ? 'true' : 'false');

                // Validate Project is required for Purchase, Sale, Expense, and Hazri
                var voucherType = '@Model.VoucherType';
                var projectId = $('#ProjectId').val();

                if ((voucherType === 'Purchase' || voucherType === 'Sale' ||
                     voucherType === 'Expense' || voucherType === 'Hazri') && !projectId) {
                    e.preventDefault();
                    alert('Project is required for ' + voucherType + ' vouchers. Please select a project.');
                    $('#ProjectId').focus();
                    return false;
                }
            });

            // Arrow key navigation for Select2 search boxes
            $(document).on('keydown', '.select2-search__field', function(e) {
                // Arrow Right - Close dropdown and move to next field
                if (e.keyCode === 39) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Find which Select2 this search belongs to
                    var $container = $(this).closest('.select2-container');
                    var $select = $($container.prev('select.select2-hidden-accessible'));

                    // Close the dropdown
                    $select.select2('close');

                    // Find next field
                    var $allInputs = $(formInputs).not(':disabled');
                    var currentIndex = $allInputs.index($select[0]);

                    if (currentIndex < $allInputs.length - 1) {
                        var $nextInput = $allInputs.eq(currentIndex + 1);
                        if ($nextInput.hasClass('select2-hidden-accessible')) {
                            $nextInput.select2('open');
                        } else {
                            $nextInput.focus().select();
                        }
                    }
                }

                // Arrow Left - Close dropdown and move to previous field
                if (e.keyCode === 37) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Find which Select2 this search belongs to
                    var $container = $(this).closest('.select2-container');
                    var $select = $($container.prev('select.select2-hidden-accessible'));

                    // Close the dropdown
                    $select.select2('close');

                    // Find previous field
                    var $allInputs = $(formInputs).not(':disabled');
                    var currentIndex = $allInputs.index($select[0]);

                    if (currentIndex > 0) {
                        var $prevInput = $allInputs.eq(currentIndex - 1);
                        if ($prevInput.hasClass('select2-hidden-accessible')) {
                            $prevInput.select2('open');
                        } else {
                            $prevInput.focus().select();
                        }
                    }
                }
            });

            // Get transaction number on load
            $.get('/Vouchers/GetTransactionNumber?type=@Model.VoucherType', function(data) {
                $('#TransactionNumber').val(data.transactionNumber);
            });

            // Show/hide sections based on voucher type
            var voucherType = '@Model.VoucherType';
            configureFormForVoucherType(voucherType);

            // Handle cash type change
            $('#cashType').on('change', function() {
                var voucherType = '@Model.VoucherType';
                if ($(this).val() == 'Bank') {
                    $('#bankColumn').show();
                    // For Purchase voucher, hide Bank Receiver column
                    if (voucherType === 'Purchase') {
                        $('#bankReceiverColumn').hide();
                    } else {
                        $('#bankReceiverColumn').show();
                    }
                } else {
                    $('#bankColumn, #bankReceiverColumn').hide();
                }
            });

            // Calculate Weight, Kat, and Quantity when Mon changes
            $('#Mon').on('input', function() {
                var mon = parseFloat($(this).val()) || 0;
                var weight = mon * 40;
                $('#weight').val(weight.toFixed(3));
                $('#kat').val(0);
                var quantity = weight - 0;
                $('#quantity').val(quantity.toFixed(3));
                // Trigger amount calculation
                $('#quantity').trigger('change');
            });

            // Calculate Quantity when Weight or Kat changes
            $('#weight, #kat').on('input', function() {
                var weight = parseFloat($('#weight').val()) || 0;
                var kat = parseFloat($('#kat').val()) || 0;
                var quantity = weight - kat;
                $('#quantity').val(quantity.toFixed(3));
                // Trigger amount calculation
                $('#quantity').trigger('change');
            });

            // Calculate amount when Quantity or Rate changes
            $('#quantity, #rate').on('input change', function() {
                var qty = parseFloat($('#quantity').val()) || 0;
                var rate = parseFloat($('#rate').val()) || 0;
                $('#amount').val((qty * rate).toFixed(2));
            });

            // Get item rate based on Receiving Customer (for Sale) or Purchasing Customer
            $('#itemSelect, #receivingCustomer, #purchasingCustomer').on('change', function() {
                var itemId = $('#itemSelect').val();
                var voucherType = '@Model.VoucherType';
                var customerId;

                // For Sale vouchers, use Receiving Customer; for Purchase, use Purchasing Customer
                if (voucherType === 'Sale') {
                    customerId = $('#receivingCustomer').val();
                } else {
                    customerId = $('#purchasingCustomer').val();
                }

                if (itemId && customerId) {
                    $.get('/Vouchers/GetItemRate', { itemId: itemId, customerId: customerId }, function(data) {
                        $('#rate').val(data.rate);
                        $('#quantity').trigger('change');
                    });
                }
            });

            // Sync Expense Head Rate with Amount ONLY for Expense vouchers
            $('#expenseHeadRate').on('input', function() {
                var voucherType = '@Model.VoucherType';
                var expenseRate = parseFloat($(this).val()) || 0;

                if (voucherType === 'Expense') {
                    // For Expense voucher only, expense rate directly sets amount
                    $('#amount').val(expenseRate.toFixed(2));
                }
                // For Purchase/Sale vouchers, expense rate does NOT affect amount
            });

            $('#amount').on('input', function() {
                var voucherType = '@Model.VoucherType';
                if (voucherType === 'Expense') {
                    var amount = parseFloat($(this).val()) || 0;
                    $('#expenseHeadRate').val(amount.toFixed(2));
                }
            });

            // Copy customer name to clipboard
            $('#copyPurchasingCustomerName').on('click', function() {
                var selectedText = $('#purchasingCustomer option:selected').text();
                if (selectedText && selectedText !== 'Select Customer') {
                    navigator.clipboard.writeText(selectedText).then(function() {
                        // Visual feedback
                        var btn = $('#copyPurchasingCustomerName');
                        var originalHTML = btn.html();
                        btn.html('<i class="bi bi-check"></i>');
                        setTimeout(function() {
                            btn.html(originalHTML);
                        }, 1000);
                    });
                }
            });

            $('#copyReceivingCustomerName').on('click', function() {
                var selectedText = $('#receivingCustomer option:selected').text();
                if (selectedText && selectedText !== 'Select Customer') {
                    navigator.clipboard.writeText(selectedText).then(function() {
                        // Visual feedback
                        var btn = $('#copyReceivingCustomerName');
                        var originalHTML = btn.html();
                        btn.html('<i class="bi bi-check"></i>');
                        setTimeout(function() {
                            btn.html(originalHTML);
                        }, 1000);
                    });
                }
            });
        });

        function configureFormForVoucherType(type) {
            // Reset all columns - hide all by default
            $('#purchasingCustomerColumn, #receivingCustomerColumn, #bankColumn, #bankReceiverColumn').hide();
            $('#itemColumn, #monWeightColumn, #katQuantityColumn, #expenseHeadColumn, #gariStockColumn').hide();

            // Always show these by default
            $('#projectCashTypeColumn, #rateAmountColumn').show();
            $('#projectRow, #cashTypeRow, #rateRow').show();

            switch(type) {
                case 'Purchase':
                    $('#purchasingCustomerColumn, #itemColumn, #monWeightColumn, #katQuantityColumn').show();
                    $('#expenseHeadColumn, #gariStockColumn').show();
                    $('#stockIncludeRow').show();
                    break;
                case 'Sale':
                    $('#receivingCustomerColumn, #itemColumn, #monWeightColumn, #katQuantityColumn').show();
                    $('#expenseHeadColumn, #gariStockColumn').show();
                    $('#stockIncludeRow').show();
                    break;
                case 'Expense':
                    $('#expenseHeadColumn').show();
                    $('#rateRow').hide();
                    break;
                case 'Hazri':
                    $('#expenseHeadColumn, #katQuantityColumn').show();
                    $('#cashTypeRow').hide();
                    $('#expenseRateRow').hide();
                    break;
                case 'CashPaid':
                    $('#purchasingCustomerColumn').show();
                    $('#projectRow').hide();
                    $('#rateRow').hide();
                    break;
                case 'CashReceived':
                    $('#receivingCustomerColumn').show();
                    $('#projectRow').hide();
                    $('#rateRow').hide();
                    break;
                case 'CCR':
                    $('#purchasingCustomerColumn, #receivingCustomerColumn').show();
                    $('#projectRow, #cashTypeRow, #rateRow').hide();
                    break;
                case 'BCR':
                    $('#bankColumn, #bankReceiverColumn').show();
                    $('#projectRow, #cashTypeRow, #rateRow').hide();
                    break;
            }
        }
    </script>
}
